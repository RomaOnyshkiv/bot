variables:
  TARGETARCH: amd64
  TARGETOS: linux
  REGISTRY: ghcr.io
  APP: "bot"
  TELE_TOKEN: $TELE_TOKEN

stages:
  - test
  - build

test:
  stage: test
  image: golang:latest
  script:
    - make test
  only:
    - main

build:
  stage: build
  image: ubuntu:latest
  services:
    - docker:dind
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -fsSL https://get.docker.com -o get-docker.sh
    - sh get-docker.sh
    - apt-get install -y docker-ce docker-ce-cli containerd.io
    - apt-get update && apt-get install -y make
    - systemctl start docker
    - sudo groupadd docker
    - sudo gpasswd -a $USER docker
  script:
    - echo TELE_TOKEN=$TELE_TOKEN >> .env
    - echo $REGISTRY_TOKEN | docker login ghcr.io -u $REGISTRY_USERNAME --password-stdin
    - cat .env && make image REGISTRY=$REGISTRY/$REGISTRY_USERNAME
    - make push REGISTRY=$REGISTRY/$REGISTRY_USERNAME
