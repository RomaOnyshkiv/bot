variables:
  TARGETARCH: amd64
  TARGETOS: linux
  REGISTRY: ghcr.io
  APP: "bot"
  TELE_TOKEN: $TELE_TOKEN

stages:
  - test
  - build

test:
  stage: test
  image: golang:latest
  script:
    - make test
  only:
    - main

build:
  stage: build
  image: ubuntu:latest
  services:
    - docker:dind
  script:
    - echo TELE_TOKEN=$TELE_TOKEN >> .env
    - echo $REGISTRY_TOKEN | docker login ghcr.io -u $REGISTRY_USERNAME --password-stdin
    - cat .env && make image REGISTRY=$REGISTRY/$REGISTRY_USERNAME
    - make push REGISTRY=$REGISTRY/$REGISTRY_USERNAME
